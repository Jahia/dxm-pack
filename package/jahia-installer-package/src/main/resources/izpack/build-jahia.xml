<?xml version="1.0"?>

<project name="jahia" default="jahia-configure" basedir="${install.path}">

	<available file="${install.path}" type="dir" property="cnd.install.dir.exists"/>

	<target name="jahia-configure">
		<echo>Configuring Jahia...</echo>
		<java jar="${install.path}/tools/configurators.jar" fork="true" failonerror="true" maxmemory="512m">
			<sysproperty key="derby.system.home" value="${jahia.war.target.path}/WEB-INF/var/dbdata" />
			<arg value="--configure" />
			<arg value="${install.path}/logs/install.properties" />
		</java>
		<echo>...done configuring Jahia.</echo>
		<condition property="cnd.no.tomcat">
			<equals arg1="${use.bundled.tomcat}" arg2="false"/>
		</condition>
		<antcall target="jahia-package"/>
		<antcall target="cleanup"/>
	</target>

	<target name="jahia-package" if="cnd.no.tomcat">
		<echo>Tomcat bundle is not selected. Packaging Jahia into a WAR file...</echo>
		<java jar="${install.path}/tools/archivers.jar" fork="true" failonerror="true" maxmemory="512m">
			<arg value="-cm"/>
			<arg value="${install.path}/build"/>
			<arg value="${install.path}/${jahia.war.target.dir.name}.war"/>
			<arg value="${server.type}"/>
		</java>
		<echo>...packaging done.</echo>
	</target>

	<target name="cleanup">
        <delete file="${install.path}/tools/archivers.jar" />
		<propertyfile file="${install.path}/logs/install.properties">
			<entry key="databasePassword" value="***"/>
			<entry key="jahiaRootPassword" value="***"/>
			<entry key="jahiaToolManagerPassword" value="***"/>
			<entry key="mailServer" value="***"/>
		</propertyfile>
	</target>
	
	<target name="jahia-cleanup-install-dir" if="cnd.install.dir.exists">
		<delete includeemptydirs="true" verbose="true">
			<fileset dir="${install.path}" includes="**/*" excludes="logs/**"/>
		</delete>
	</target>

</project>
